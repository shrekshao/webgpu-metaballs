<!doctype html>

<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>

    <title>WebGPU Metaballs</title>

    <style>
      html, body {
        height: 100%;
        margin: 0;
        background-color: #000000;
      }

      canvas {
        position: absolute;
        z-index: 0;
        height: 100%;
        width: 100%;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        margin: 0;
        touch-action: none;
      }

      .dg.main {
        position: absolute;
        z-index: 100;
        top: 1em;
        right: 1em;
      }
    </style>
  </head>
  <body>
    <script type="importmap">
    {
        "imports": {
            "gl-matrix": "./node_modules/gl-matrix/dist/esm/index.js",
            "webgl-texture-loader": "./node_modules/web-texture-tool/build/webgl-texture-loader.js",
            "webgpu-texture-loader": "./node_modules/web-texture-tool/build/webgpu-texture-loader.js",
            "dat.gui": "./node_modules/dat.gui/build/dat.gui.module.js",
            "stats.js": "./node_modules/stats.js/src/Stats.js"
        }
    }
    </script>
    <script type="module">
      import dat from 'dat.gui';
      import Stats from 'stats.js';

      import { Gltf2Loader } from './js/mini-gltf2.js';
      import { FlyingCamera } from './js/camera.js';

      import { WebGPURenderer } from './js/webgpu-renderer/webgpu-renderer.js';

      let renderer = null;
      let gltf = null;

      const stats = new Stats();
      document.body.appendChild(stats.dom);

      const camera = new FlyingCamera();
      camera.position = [0, 1.5, 3];
      //camera.rotateView(-Math.PI * 0.5, 0);

      const appSettings = {
        renderer: 'webGPU',
        output: 'clustered-forward',
        mesh: './media/models/dungeon/dungeon.glb',
        renderLightSprites: true,
        lightCount: 128,
        maxLightRange: 2,
      };

      let gui = new dat.GUI();

      /*gui.add(appSettings, 'renderer', {
        webGPU: 'webGPU'
      }).onChange(onApiChange);*/

      gui.add(appSettings, 'renderLightSprites').onChange(() => {
        if (renderer) {
          renderer.lightManager.render = appSettings.renderLightSprites;
        }
      });

      document.body.appendChild(gui.domElement);

      async function onApiChange() {
        let prevCanvas;
        if (renderer) {
          prevCanvas = renderer.canvas;
          renderer.stop();
          camera.element = null;
        }

        switch(appSettings.renderer) {
          case 'webGL2':
            renderer = new WebGL2Renderer();
            break;
          case 'webGPU':
            renderer = new WebGPURenderer();
            break;
          default:
            renderer = null;
            if (prevCanvas) {
              document.body.removeChild(prevCanvas);
            }
            break;
        }

        if (renderer) {
          try {
            await renderer.init();
            renderer.setStats(stats);
            if (gltf) {
              await renderer.setGltf(gltf);
            }
            renderer.camera = camera;
            if (prevCanvas) {
              document.body.removeChild(prevCanvas);
            }
            document.body.appendChild(renderer.canvas);
            camera.element = renderer.canvas;
            renderer.lightManager.lightCount = appSettings.lightCount;
            renderer.updateLightRange(appSettings.maxLightRange);
            renderer.lightManager.render = appSettings.renderLightSprites;

            onOutputChange();

            renderer.start();
          } catch (err) {
            console.error('renderer init failed', err);
            renderer.stop();
            renderer = null;
          }
        }
      }
      onApiChange();

      function onOutputChange() {
        if (renderer) {
          renderer.setOutputType(appSettings.output);
        }
      }

      function onLightPatternChange() {
        if (renderer) {
          renderer.onLightPatternChange(appSettings.lightPattern);
        }
      }

      async function initGltf() {
        const gltfLoader = new Gltf2Loader();
        gltf = await gltfLoader.loadFromUrl(appSettings.mesh);
        if (renderer) {
          renderer.setGltf(gltf);
        }
      }
      initGltf();

    </script>
  </body>
</html>